# 移植元実装におけるマウスボタンとショットの関係性についての解析レポート

## 1. はじめに

本レポートは、移植元であるC++版CannonSmashのソースコードを解析し、ラリー中にクリックされるマウスボタンの種類が、打球にどのような影響を与えているかを報告するものである。

## 2. 解析の概要

結論として、クリックされたマウスボタンの種類は、ボールに与える**回転（スピン）**のベクトルを変化させる。これにより、打球の軌道が変化する。

解析の過程は以下の通りである。

1.  マウス入力を処理している箇所を特定した。
2.  各マウスボタンのクリックが、どの関数呼び出しに対応しているかを調査した。
3.  その関数に渡される引数が、最終的にボールのどの物理パラメータに影響を与えるかを解明した。

## 3. 詳細な解析結果

### 3.1. マウス入力の処理箇所

プレイヤーのマウス入力は、`csmash/HumanController.cpp` ファイル内の `HumanController::KeyCheck` メソッドで処理されている。

このメソッド内で、マウスの左、中央、右ボタンが押された瞬間を検出し、それぞれ異なる処理を実行している。

### 3.2. マウスボタンと `Swing` メソッドの関連付け

解析の結果、ラリー中（サーブ以外の場面）に各マウスボタンがクリックされると、`Player` オブジェクトの `Swing` メソッドが、それぞれ異なる引数で呼び出されることが判明した。

-   **左クリック**: `m_parent->Swing(1)` を呼び出す。
-   **中央クリック**: `m_parent->Swing(2)` を呼び出す。
-   **右クリック**: `m_parent->Swing(3)` を呼び出す。

### 3.3. `Swing` メソッド引数の役割：スピンの種類の選択

`Player` クラスの `Swing` メソッド（`Player.cpp` 内で `Player::Swing(long spin)` として定義）は、引数 `spin` を受け取る。この `spin` こそが、マウスボタンに応じて渡される `1`, `2`, `3` の値である。

この `spin` 引数が具体的にどのように使われるかは、サーブ時の処理を担う `Player::StartServe` メソッドの実装から最も明確に理解できる。

```cpp
// csmash/Player.cpp L.1005 Player::StartServe( long spin ) より抜粋

// スピンのパラメータを定義したテーブル
double sparam[][7] = { {SERVE_NORMAL,     0.0, 0.0,  0.0,  0.1,  0.0,  0.2},
                       {SERVE_POKE,       0.0, 0.0,  0.0, -0.3,  0.0, -0.6},
                       {SERVE_SIDESPIN1, -0.6, 0.2, -0.8,  0.0, -0.6, -0.2},
                       {SERVE_SIDESPIN2,  0.6, 0.2,  0.8,  0.0,  0.6, -0.2},
                       {-1,               0.0, 0.0,  0.0,  0.0,  0.0,  0.0}};

// ... 中略 ...

while ( sparam[i][0] > 0 ) {
  if ( (long)sparam[i][0] == m_swingType ) { // m_swingType はサーブの種類
    // spin の値(1, 2, 3)に応じて、sparam テーブルから異なる列の値を取得し、
    // プレイヤーがボールに与える回転ベクトル m_spin に設定する。
    m_spin[0] = sparam[i][(spin-1)*2+1];
    m_spin[1] = sparam[i][(spin-1)*2+2];
    break;
  }
  i++;
}
```

このコードが示すように、`spin` 引数は、スピンのパラメータが格納された2次元配列 `sparam` の**列を選択するためのインデックス**として機能している。

-   `spin=1` (左クリック) の場合: `(1-1)*2+1 = 1` 列目と `2` 列目の値が、スピンのX成分とY成分 (`m_spin[0]`, `m_spin[1]`) として設定される。
-   `spin=2` (中央クリック) の場合: `(2-1)*2+1 = 3` 列目と `4` 列目の値が設定される。
-   `spin=3` (右クリック) の場合: `(3-1)*2+1 = 5` 列目と `6` 列目の値が設定される。

例えば、サーブの種類が `SERVE_SIDESPIN1` の場合：
-   左クリック (`spin=1`): `m_spin` は `(-0.6, 0.2)` となり、強い左横回転と少しのトップスピンがかかる。
-   中央クリック (`spin=2`): `m_spin` は `(-0.8, 0.0)` となり、より強い純粋な左横回転がかかる。
-   右クリック (`spin=3`): `m_spin` は `(-0.6, -0.2)` となり、強い左横回転と少しのバックスピンがかかる。

ラリー中の `SwingType` の決定ロジックは、サーブ時よりも複雑で、プレイヤーの種類や状況に応じて動的に変化するが、マウスボタンのクリックが `spin` 引数(1, 2, 3)を経由して、最終的にボールに与える回転ベクトル `m_spin` の値をテーブルから選択している、という基本原理は同一である。

## 4. 結論

移植元実装では、ラリー中にクリックするマウスボタンの種類によって、`Player::Swing` メソッドに渡される `spin` 引数の値が `1`, `2`, `3` と変化する。この `spin` 引数が、予め定義されたテーブルから異なる**回転ベクトル (`m_spin`)** を引き出すためのキーとして機能することで、打球に与えるスピンを変化させ、ショットの打ち分けを実現している。

以上。
