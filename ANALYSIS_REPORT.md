# 移植元実装におけるマウスボタンとショットの関係性についての解析レポート

## 1. はじめに

本レポートは、移植元であるC++版CannonSmashのソースコードを解析し、クリックされるマウスボタンの種類が、**サーブ**および**ラリー中の打球**にどのような影響を与えているかを報告するものである。

## 2. 解析の概要

結論として、マウスボタンの種類が打球に与える影響は、**サーブ時とラリー時で大きく異なる**。

-   **サーブ時**: マウスボタンの種類（左, 中央, 右）に応じて、ボールに与える**回転（スピン）**のベクトルが明確に変化する。
-   **ラリー時**: **全てのプレイヤータイプにおいて、マウスボタンの種類は打球に一切影響を与えない**。ショットの種類とスピンは、飛んでくるボールの状況に応じて完全に自動で決定される。

## 3. 詳細な解析結果

### 3.1. マウス入力から `Swing` メソッド呼び出しまで

プレイヤーのマウス入力は、`csmash/HumanController.cpp` で処理される。ここで、マウスの左、中央、右ボタンが押されると、`Player` オブジェクトの `Swing` メソッドが、それぞれ異なる引数で呼び出される。

-   **左クリック**: `m_parent->Swing(1)`
-   **中央クリック**: `m_parent->Swing(2)`
-   **右クリック**: `m_parent->Swing(3)`

この `Swing` メソッドに渡される引数 `spin` (1, 2, 3) が、ショットに影響を与えるかどうかの鍵となる。

### 3.2. サーブ時のスピン決定ロジック

サーブ時は、`Player::StartServe` メソッドが呼び出される。このメソッド内では、`spin` 引数の値に応じて、スピンのパラメータが格納されたテーブル `sparam` から異なる値が選択され、ボールに与える回転ベクトル `m_spin` が設定される。

```cpp
// csmash/Player.cpp L.1005 Player::StartServe( long spin ) より抜粋
double sparam[][7] = { {SERVE_NORMAL,     0.0, 0.0,  0.0,  0.1,  0.0,  0.2},
                       {SERVE_SIDESPIN1, -0.6, 0.2, -0.8,  0.0, -0.6, -0.2},
                       ... };

// spin (1, 2, 3) の値に応じて sparam テーブルから異なる列の値を取得する
m_spin[0] = sparam[i][(spin-1)*2+1];
m_spin[1] = sparam[i][(spin-1)*2+2];
```

-   `spin=1` (左クリック): 1, 2列目の値を使用
-   `spin=2` (中央クリック): 3, 4列目の値を使用
-   `spin=3` (右クリック): 5, 6列目の値を使用

このように、サーブ時はマウスボタンの種類によって、明確にスピンが変化する。

### 3.3. ラリー時のスピン決定ロジック

ラリー時は、各プレイヤータイプ（`ShakeCut`, `PenDrive`, `PenAttack`）に特化した `SwingType` メソッドが呼び出される。

#### 3.3.1. `PLAYER_SHAKECUT` (シェーク・カットマン)

`ShakeCut::SwingType` (`ShakeCut.cpp`) が実装されている。このメソッドは、飛んでくるボールの位置、速度、回転を分析し、状況に応じて `SWING_CUT` や `SWING_DRIVE` などのショットの種類と、それに応じたスピン量を**自動的に決定**する。

**`spin` 引数（マウスボタンに対応）は、このロジックで一切使用されていない。**

```cpp
// csmash/ShakeCut.cpp より抜粋
bool ShakeCut::SwingType( Ball *ball, long spin ) { // 'spin'引数は未使用
  if ( ball->GetV()[2] < 0 ) { // 球が落下中なら
    m_swingType = SWING_CUT;
    m_spin[1] = -1.0; // 固定値の強いバックスピン（カット）
  } else { // 球が上昇中なら
    m_swingType = SWING_DRIVE;
    m_spin[1] = 0.6; // 固定値のトップスピン（ドライブ）
  }
  // ...
}
```

#### 3.3.2. `PLAYER_PENDRIVE` (ペン・ドライブマン)

`PenDrive::SwingType` (`PenDrive.cpp`) が実装されている。ロジックは `ShakeCut` とほぼ同様で、**`spin` 引数は使用されず**、状況に応じた固定値のスピンが自動的に設定される。

#### 3.3.3. `PLAYER_PENATTACK` (ペン・速攻型)

`PenAttack::SwingType` (`PenAttack.cpp`) が実装されている。こちらも他のタイプと同様、**`spin` 引数は使用されず**、状況に応じた固定値のスピンが自動的に設定される。

## 4. 総括

当初の「ラリー中でもマウスボタンによってショットが変化する」という想定は、ソースコードの現状とは異なっていた。

-   **サーブ**: マウスボタンの種類でスピンを打ち分けることができる。
-   **ラリー**: ショットの種類やスピンは、ボールの状況に応じて**完全に自動で決定**され、プレイヤーがマウスボタンで介入する余地はない。

コード中には、`//m_spin = -spin*0.2-0.4;` のように、かつて `spin` 引数を使っていたことを示唆するコメントアウトされた行が複数見つかった。これは、開発の初期段階ではラリー中もマウスボタンでショットを打ち分ける仕様だったが、その後、より自動化された現在のロジックに変更された可能性を示唆している。

以上。
