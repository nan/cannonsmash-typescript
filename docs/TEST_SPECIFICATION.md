# テスト仕様書

このドキュメントは、プロジェクトに実装されている自動テストの仕様を定義します。

## 1. ユニットテスト

ユニットテストは、個々のモジュール（クラスや関数）が期待通りに動作することを検証します。

### 1.1. ScoreManager (`tests/unit/ScoreManager.test.ts`)

**テスト対象:** `ScoreManager`クラスのスコア計算、状態管理、サーブ権判定ロジック

| テストケースID | テスト内容 | 前提条件 | 手順 | 期待される結果 |
| :--- | :--- | :--- | :--- | :--- |
| **SM-01** | **初期化** | - | 1. `ScoreManager`の新しいインスタンスを作成する。 | 1. `score1`と`score2`が`0`であること。<br>2. `isGameOver`が`false`であること。 |
| **SM-02** | **リセット** | スコア (`score1`, `score2`) とゲームオーバー状態 (`isGameOver`) が任意の値に設定されている。 | 1. `reset()`メソッドを呼び出す。 | 1. `score1`と`score2`が`0`に戻ること。<br>2. `isGameOver`が`false`に戻ること。 |
| **SM-03** | **プレイヤー1へのポイント付与** | ゲームが進行中である。 | 1. プレイヤー1（人間）がポイントを獲得する状況を示す`BallStatus`で`awardPoint()`を呼び出す。 | 1. `score1`が`1`増加すること。<br>2. `score2`は変動しないこと。 |
| **SM-04** | **プレイヤー2へのポイント付与** | ゲームが進行中である。 | 1. プレイヤー2（AI）がポイントを獲得する状況を示す`BallStatus`で`awardPoint()`を呼び出す。 | 1. `score2`が`1`増加すること。<br>2. `score1`は変動しないこと。 |
| **SM-05** | **ゲームオーバー時のポイント付与** | `isGameOver`が`true`である。 | 1. `awardPoint()`を呼び出す。 | 1. `score1`と`score2`が変動しないこと。 |
| **SM-06** | **ゲーム終了条件（通常）** | スコアが10-9（プレイヤー1リード）。 | 1. プレイヤー1がポイントを獲得する。 | 1. `isGameOver`が`true`になること。<br>2. スコアボードの表示が "You Win!" になること。 |
| **SM-07** | **ゲーム終了条件（デュース - 続行）** | スコアが10-10。 | 1. プレイヤー1がポイントを獲得する。 | 1. `isGameOver`が`false`のままであること。 |
| **SM-08** | **ゲーム終了条件（デュース - 終了）** | スコアが11-10（プレイヤー1リード）。 | 1. プレイヤー1がポイントを獲得する。 | 1. `isGameOver`が`true`になること。 |
| **SM-09** | **ゲーム終了後の画面遷移** | ゲームが終了する条件が満たされている。 | 1. `awardPoint()`を呼び出す。<br>2. `setTimeout`で設定された時間が経過する。 | 1. `returnToDemo()`メソッドが呼び出されること。 |
| **SM-10** | **サーブ権判定（11ポイント制）** | ゲームが進行中である。 | 1. 様々なスコア状況で`getService()`を呼び出す。<br>   - 0-0<br>   - 2-0<br>   - 10-10<br>   - 11-10 | 1. 各スコア状況に応じて、正しいプレイヤー (`1`または`-1`) にサーブ権が与えられること。 |

### 1.2. Ball (`tests/unit/Ball.test.ts`)

**テスト対象:** `Ball`クラスの物理演算、状態管理、衝突判定ロジック

| テストケースID | テスト内容 | 前提条件 | 手順 | 期待される結果 |
| :--- | :--- | :--- | :--- | :--- |
| **BL-01** | **初期化** | - | 1. `Ball`の新しいインスタンスを作成する。 | 1. ボールが定義された初期位置に配置されること。<br>2. 速度とスピンがゼロであること。<br>3. `status`が`BallStatus.STOP`であること。 |
| **BL-02** | **物理演算（重力と空気抵抗）** | ボールが空中にあり、上向きの初速を持つ。 | 1. `_updatePhysics()`を複数回呼び出す。 | 1. ボールのY座標が放物線を描いて変化すること。<br>2. 速度が徐々に減衰すること。 |
| **BL-03** | **テーブルとの衝突** | ボールがテーブルに向かって落下している。 | 1. `_updatePhysics()`を呼び出し、ボールがテーブルの高さに達する。 | 1. ボールのY方向の速度が反転し、反発係数に応じて減衰すること。<br>2. スピンが速度に影響を与えること。 |
| **BL-04** | **ネットとの衝突** | ボールがネットに向かって直進している。 | 1. `_updatePhysics()`を呼び出し、ボールがネットのZ座標に達する。 | 1. ボールのZ方向の速度が反転すること。 |
| **BL-05** | **壁との衝突（左右）** | ボールが左右の壁に向かって移動している。 | 1. `_updatePhysics()`を呼び出し、ボールが壁のX座標に達する。 | 1. ボールのX方向の速度が反転すること。 |
| **BL-06** | **壁との衝突（奥）** | ボールが奥の壁に向かって移動している。 | 1. `_updatePhysics()`を呼び出し、ボールが奥の壁のZ座標に達する。 | 1. ボールのZ方向の速度が反転すること。 |
| **BL-07** | **状態遷移（サーブ）** | プレイヤーがサーブの準備ができている。 | 1. `serve()`メソッドを呼び出す。 | 1. ボールの`status`が適切なサーブ状態に遷移すること。<br>2. ボールに初速とスピンが与えられること。 |

### 1.3. AIController (`tests/unit/AIController.test.ts`)

**テスト対象:** `AIController`クラスの意思決定ロジック（移動、サーブ、返球）

| テストケースID | テスト内容 | 前提条件 | 手順 | 期待される結果 |
| :--- | :--- | :--- | :--- | :--- |
| **AI-01** | **初期化** | - | 1. `AIController`の新しいインスタンスを作成する。 | 1. `level`や`player`などのプロパティが正しく設定されること。 |
| **AI-02** | **移動判断（待機状態）** | ボールがサーブ待ち状態 (`WAITING_FOR_SERVE`) である。 | 1. `update()`メソッドを呼び出す。 | 1. AIプレイヤーが初期位置（またはサーブ準備位置）に移動しようとすること。 |
| **AI-03** | **移動判断（ラリー中）** | ボールがAI側に向かってきている (`RALLY_TO_AI`)。 | 1. `update()`メソッドを呼び出す。 | 1. AIプレイヤーがボールの予測落下地点に移動しようとすること。 |
| **AI-04** | **サーブ実行判断** | サーブ権がAIにあり、ボールがサーブ待ち状態である。 | 1. `update()`を複数回呼び出す。 | 1. AIプレイヤーがサーブのトスを行い、適切なタイミングでスイング（`startServe`）すること。 |
| **AI-05** | **返球実行判断** | ボールがAI側コートでバウンドし、返球可能な状態 (`RALLY_TO_AI`) である。 | 1. `update()`を複数回呼び出す。 | 1. AIプレイヤーが適切なタイミングでスイング（`startSwing`）すること。<br>**注:** このロジックはボールの未来位置予測やプレイヤーの移動など、多数の状態が複雑に絡み合うため、ユニットテストでの完全な再現が困難。現在はスキップ中。 |
| **AI-06** | **デモモードでの動作** | ゲームがデモモードである。 | 1. `update()`を呼び出す。 | 1. AIが自動的にラリーを続けること。 |

---

## 2. E2E（エンドツーエンド）テスト

E2Eテストは、アプリケーション全体が実際のユーザー環境（ブラウザ）で正しく動作することを検証します。

### 2.1. アプリケーション起動 (`tests/smoke.spec.ts`)

**テスト対象:** アプリケーションの起動と初期表示

| テストケースID | テスト内容 | 前提条件 | 手順 | 期待される結果 |
| :--- | :--- | :--- | :--- | :--- |
| **E2E-01** | **スモークテスト** | 開発サーバーが起動している。 | 1. アプリケーションのルートURL (`/`) にアクセスする。<br>2. ページのタイトルを検証する。<br>3. ブラウザのコンソール出力を監視する。 | 1. ページのタイトルに "CannonSmash" が含まれていること。<br>2. `error`レベルのコンソールログが出力されないこと。 |
