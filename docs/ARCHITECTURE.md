# アーキテクチャ概要

このプロジェクトは、関心の分離 (Separation of Concerns) を意識したアーキテクチャを採用しています。主要なクラスとその役割は以下の通りです。

## 主要コンポーネント

-   **`main.ts` (コントローラー):**
    -   アプリケーションのエントリーポイントです。
    -   Three.jsのシーン、カメラ、レンダラーの初期化を行います。
    -   ブラウザイベント（ウィンドウリサイズ、キー入力、ポインターロック）を監視します。
    -   ユーザーからの入力を `InputManager` に伝え、ゲームのメインループ (`Game.ts`) を呼び出す責務を持ちます。

-   **`Game.ts` (モデル / ゲームロジック):**
    -   ゲーム全体の状態（デモ、プレイ中、一時停止など）を管理するコアクラスです。
    -   `Player`, `Ball`, `AIController` などの主要なオブジェクトを保持し、それらの更新処理を呼び出します。
    -   スコア計算、サーブ権の管理、ゲームのリセットなど、ゲームのルールに関わるロジックを担当します。
    -   **State パターン:** `DemoMode` や `PlayMode` といったモードクラスに処理を委譲することで、状態に応じた振る舞いを切り替えています。

-   **`Player.ts`:**
    -   プレイヤー（人間・AI共通）のモデル、アニメーション、状態を管理します。
    -   移動、スイング、サーブといったプレイヤーのアクションを定義します。
    -   AIプレイヤーの場合、`AIController` によって行動が決定されます。

-   **`Ball.ts`:**
    -   ボールの物理演算（移動、回転、スピンによる軌道の変化）、衝突判定（テーブル、ネット、床）、状態管理を担当します。
    -   ボールの状態は `status` プロパティによって管理され、サーブ、ラリー、アウトなどの状況を示します。

-   **`AIController.ts`:**
    -   AIプレイヤーの思考ロジックを専門に扱います。
    -   ボールの軌道を予測し、最適な打点、移動先、使用するスイングを決定します。
    -   `Player` オブジェクトを操作して、決定した行動を実行させます。

-   **`InputManager.ts` & `InputController.ts`:**
    -   `InputManager.ts` は、マウスクリックやマウス移動といった低レベルなユーザー入力を取得し、管理するシングルトンです。
    -   `InputController.ts` は、`InputManager` からの入力に基づき、「サーブ」や「スイング」といったゲーム固有の具体的なアクションに変換する責務を持ちます。

-   **`ScoreManager.ts`:**
    -   得点計算、サーブ権の管理、ポイント終了後のボールのリセットなど、スコアリングに関連するすべてのロジックを集約しています。

-   **`UIManager.ts` (ビュー管理):**
    -   HTML要素で構成されるUI（デモ画面、一時停止画面、スコア表示など）の表示・非表示を管理します。

## データフローの例 (プレイヤーのスイング)

1.  **`main.ts`**: ユーザーがマウスをクリックすると、そのイベントを検知します。
2.  **`InputManager.ts`**: マウスクリックのイベントを記録します。
3.  **`Game.ts` (update loop):**
    a. `InputController.ts` の更新処理を呼び出します。
    b. `InputController.ts` は `InputManager` を見てクリックを検知し、現在のゲーム状態（サーブ待ちなど）に応じて `player.startSwing()` などを呼び出します。
4.  **`Player.ts`**: `startSwing()` メソッドが実行され、スイングのアニメーションを開始し、プレイヤーの状態を「スイング中」に更新します。
5.  **`Ball.ts`**: その後のフレームで、スイング中のラケットとボールの衝突判定が行われ、ヒットした場合はボールの速度とスピンが更新されます。
