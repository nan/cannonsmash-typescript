# プロジェクトの目的

このプロジェクトの主な目的は、`cannonsmash-main`にC++で実装されている卓球ゲームをTypeScriptに移植することです。

## 主要な目標

1.  **言語の移植:** C++のコードベースを、モダンで慣用的なTypeScriptに翻訳します。
2.  **機能の同等性:** TypeScript版が、オリジナルのC++版ゲームのすべての機能を持つようにします。
3.  **保守性:** クリーンで、十分に文書化され、テスト可能なTypeScriptコードを記述します。

## 開発ガイドライン

*   新しいコードはすべてTypeScriptで記述してください。
*   ロジックや機能については、オリジナルのC++実装を参照してください。
*   **オリジナルのソースコード:** [https://github.com/nan/cannonsmash](https://github.com/nan/cannonsmash)
    *   特に、ゲームロジックの重要なファイルは `csmash/Ball.cpp`, `csmash/Player.cpp`, `csmash/ttinc.h` です。

## プロジェクトの実行方法

1.  `ts-port` ディレクトリに移動します: `cd ts-port`
2.  依存関係をインストールします: `npm install`
3.  開発サーバーを起動します: `npm run dev`
4.  ブラウザで表示されたURL（通常は `http://localhost:5173` など）にアクセスします。

## ディレクトリ構成

-   `cpp_source/`: 移植元となるオリジナルのC++プロジェクトのソースコードが格納されています。(注: 現在の環境では展開に失敗する可能性があるため、上記のGitHubリンクを参照してください)
-   `ts-port/`: 移植先のTypeScriptプロジェクトです。すべての新しい開発はこのディレクトリ内で行います。

## 主要技術スタック

-   **TypeScript**: 主な開発言語です。
-   **Vite**: 開発サーバーとビルドツールとして使用します。
-   **Three.js**: 3Dグラフィックスのレンダリングに使用します。

## エージェント向けの重要な注意点

### ボールの状態 (`status`) 管理

`Ball.ts`クラスは、ボールの状態を管理するために`status`という数値プロパティを使用しています。これはオリジナルのC++コードからの直接的な移植です。

-   `status = 8`: ボールがプレイヤーに保持され、サーブ準備が整った状態。このとき、ボールの物理演算は停止します。
-   `status >= 0`: ボールがプレイ中の状態。
-   `status < 0`: ボールが「デッド」状態（例：床に落ちた、ミスショットなど）。この状態になるとリセットまでのカウントダウンが始まります。`status`が`-100`に達すると、ボールはサーブ権を持つプレイヤーの元にリセットされます。
-   **重要:** ボールがデッド状態でも、リセットされるまでは物理演算が継続されます。これにより、ボールは床で自然にバウンドし続けることができます。

### フロントエンドの検証

このゲームはブラウザベースであるため、全ての視覚的な変更は提出前に**必ず**Playwrightを使用して検証する必要があります。

-   `frontend_verification_instructions()`ツールを使用すると、検証スクリプトの書き方の詳細な手順が得られます。
-   **テストのヒント:** 特定のゲームイベントをテストするには、ゲームキャンバスへのユーザー入力をシミュレートします。
    -   **通常サーブ:** `canvas.click(button='left', ...)`
    -   **高いトス（床のバウンドテストに有効）:** `canvas.click(button='middle', ...)`

### 既知の相違点と注意点 (Known Discrepancies and Cautionary Notes)

このセクションでは、現在のTypeScript移植版とオリジナルのC++版との間で、意図的に、あるいは技術的な困難から生じている既知の相違点について説明します。

#### サーブの速度計算 (`Ball.ts`内の`targetToVS`関数)

-   **現状:** 現在のTypeScript版では、サーブ時のボールの初速は、プレイヤーの位置やターゲットに関わらない、**固定値**を返す簡易的な実装になっています。これにより、常に安定したサーブが実行されます。
-   **経緯:** オリジナルのC++版では、サーブの2バウンド目がターゲットに正確に着地するよう、非常に複雑な物理計算（反復探索）によって初速を決定しています。このロジックのTypeScriptへの完全な移植は、その複雑さから非常に困難であることが判明したため、安定性を優先した現在の簡易的な実装が採用されています。
-   **将来の作業:** この関数の完全な移植は、非常に挑戦的なタスクです。取り組む際には、`Ball.cpp`の`TargetToVS`関数と、それが依存するヘルパー関数(`getTimeToReachTarget`など)の深い理解が必要になります。

#### 一時的なテストコード

-   コードベースには、デバッグやテストのために一時的に追加されたコード（例: `Game.ts`内のキーボード入力ハンドラなど）が含まれている可能性があります。機能の挙動がおかしい場合は、このような一時的なコードが影響していないか確認してください。
